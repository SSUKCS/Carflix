Carflix Car Module
===
What is Carflix?
---

+ 차 키가 아닌 스마트폰을 이용하여 시동을 걸 수 있게 하는 서비스
+ 앱을 이용하여 차량의 블루투스 모듈과 연결해 시동을 건다.
+ 운전자 및 주차된 위치를 파악할 수 있다.

Carflix 서비스의 목표는 다음과 같다.

 1. 스마트폰과 블루투스로 통신하며 자동차 키의 기능을 모두 수행할 수 있는 차량 모듈을 설계한다.
 2. 서버와 차량 모듈 간 통신을 중재할 수 있는 스마트폰 앱을 설계한다.
 3. 특정 그룹에 속한 사람만 스마트폰을 통해 차량을 제어하거나 차량의 위치 정보를 조회할 수 있도록 한다. 
 4. 그룹의 차량과 회원을 관리하는 웹페이지를 만들고, 권한이 있는 사용자가 이를 이용할 수 있게 한다.

이 레포지토리는 carflix 서비스 구성요소 중 **차량 모듈**에 대한 레포지토리이다.

---

### 시스템 구성도
> * 사용자는 스마트폰 앱을 통하여 그룹을 생성하거나, 초대 코드를 이용하여 그룹에 가입할 수 있다. 그룹을 생성한 사람은 대표자가 되고, 그룹에 가입하면 일반 사용자가 된다.
> 
>   <img src="https://github.com/simjeehoon/src_repository/blob/master/CarflixArduino/master/service_composition.png?raw=true" title="서비스 구성" alt="service composition"></img><br/>
> 
> * 모든 그룹원은 지문/PIN 등의 본인 인증을 거친 뒤, 차량을 제어하거나 위치 정보를 조회할 수 있다. 
> * 부매니저는 대표자의 일부 권한 위임받은 사용자이다. 부매니저 권한을 가진 사용자라면, 차량 사용 기록 조회, 회원 초대, 그룹원 계급 변경 등 운영과 관련된 활동을 수행할 수 있다. 
> * 최초로 그룹을 생성한 사람이 대표자가 되는데, 유일하게 차량 등록과 삭제를 할 수 있는 사용자이다.
>
>   <img src="https://github.com/simjeehoon/src_repository/blob/master/CarflixArduino/master/group_registeration_step.png?raw=true" title="등록 과정" alt="register"></img><br/>
>   <img src="https://github.com/simjeehoon/src_repository/blob/master/CarflixArduino/master/door_step.png?raw=true" title="제어 및 시동" alt="control_step"></img><br/>
>
> * 대표자가 차량을 등록하는 과정은 [그림 2]와 같다. 스마트폰 앱에서 차량 모듈을 블루투스로 연결한 후, 서버로부터 받은 차량 ID를 할당한다. 차량 ID는 차량 제어 작업 이전에 서버로부터 작업이 유효한지 검증받기 위해 쓰이는 고유한 값이다. 이 값이 성공적으로 할당되면 차량 등록이 완료된다.
> * 등록된 차량을 삭제하는 과정도 등록 과정과 유사하다. 서버에 저장된 블루투스 MAC 주소와 탐지된 모듈의 MAC 주소가 일치할 때만 모듈의 메모리에서 ID를 지운다.
> * 사용자가 차량을 제어하는 과정은 [그림 3]과 같다. 여기서 말하는 제어란, 시동 및 문 개폐, 트렁크 개폐로서 자동차 키로 할 수 있는 보편적인 기능들이다. 먼저 지문 또는 PIN 번호 등을 이용하여 본인 인증을 한다. 이후, 블루투스로 연결된 차량 모듈에 제어/시동 요청을 전송한다. 차량 모듈은 스마트폰을 통해 서버로부터 요청의 유효성을 검증받는다. 요청이 유효하면 최종적으로 차량을 제어하게 된다.
> * 앞선 과정을 통해 시동을 거는 데 성공했다면, 모듈은 스마트폰 앱에 주기적으로 신호를 보낸다. 스마트폰 앱은 이 신호를 받으면 서버로 현재 위치, 운전자 정보를 보낸다. 만일 이 신호를 받지 못했다면 서버에 이 사실을 전달한다. 수집한 위치 정보가 유효한지 파악하기 위해서이다. 주행을 마치고 시동을 끈다면 모듈은 이 정보를 스마트폰 앱을 통해 서버로 전달하여 정보 수집을 마친다.


### 시스템 설계
> <img src="https://github.com/simjeehoon/src_repository/blob/master/CarflixArduino/master/car.png?raw=true" title="차량" alt="car"></img><br/>
> * 아두이노에 블루투스 모듈인 HC-06을 장착하여 차량 모듈을 만들었다. 모듈은 I2C 1602 LCD를 이용하여 현재 상태를 표시한다. 차량 ID를 저장하기 위한 비휘발성 메모리는 아두이노의 EEPROM을 이용하였다.
> * 모듈과 신호를 주고받는 차량을 구현하기 위해 [그림 4]와 같이 차량 모형을 만들었다. 시동이 켜졌을 때 5개의 LED가 켜지고, L298N 모터 드라이버에 연결된 DC 모터에 의해 바퀴가 굴러갈 수 있게 하였다. 
> * 또한 차량의 시동을 켜고 끌 수 있는 기능과 EEPROM를 강제로 초기화하는 기능을 구현하기 위해 tact 스위치 2개를 부착하였다. 문과 트렁크의 잠금/잠금 해제는 서보모터를 이용하여 구현하였다.

---

### 구현 코드
```c++
void loop() {
    eepromResetBtn.update();
    startBtn.update();
    lcd.update();
    reserver.update();
    bluetooth.receiveData();
}
```
* 차량 모형에 있는 각 장비들을 모두 클래스화하였다. 
* 루프를 돌면서 각 장비의 변동사항을 점검하고 이를 시스템에 반영한다.
